<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>‡∏™‡∏°‡∏∏‡∏î‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Å‡∏£‡∏£‡∏°</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://static.line-scdn.net/liff/edge/2/sdk.js"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Sarabun:wght@300;400;600&display=swap');
        body { font-family: 'Sarabun', sans-serif; background-color: #F3F4F6; }
        .tab-active { border-bottom: 2px solid #D97706; color: #D97706; font-weight: 600; } /* ‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡∏ò‡∏µ‡∏°‡πÄ‡∏õ‡πá‡∏ô‡∏™‡∏µ‡∏ó‡∏≠‡∏á */
        .hidden-section { display: none; }
    </style>
    <link rel="icon" href="logo.png">
</head>
<body class="bg-gray-50 text-gray-800 min-h-screen relative pb-20">

    <header class="bg-white shadow-sm sticky top-0 z-10">
        <div class="max-w-md mx-auto px-4 py-3 flex justify-between items-center">
            <h1 class="text-xl font-bold text-gray-800">üòá ‡∏™‡∏°‡∏∏‡∏î‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Å‡∏£‡∏£‡∏°</h1>
            <div id="user-display" class="text-xs text-gray-400">Loading...</div>
        </div>
        <nav class="flex justify-around bg-white border-t border-gray-100">
            <button onclick="switchTab('form')" id="btn-form" class="flex-1 py-3 text-sm text-gray-500 tab-active">‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å</button>
            <button onclick="switchTab('history')" id="btn-history" class="flex-1 py-3 text-sm text-gray-500">‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥</button>
            <button onclick="switchTab('leaderboard')" id="btn-leaderboard" class="flex-1 py-3 text-sm text-gray-500">‡∏≠‡∏±‡∏ô‡∏î‡∏±‡∏ö</button>
        </nav>
    </header>

    <main class="max-w-md mx-auto p-4">
        
        <section id="sec-form" class="space-y-4">
            <div class="bg-white p-6 rounded-2xl shadow-sm border border-gray-100">
                <h2 class="text-lg font-semibold mb-4 text-gray-700">‡πÉ‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•</h2>
                <form id="scoreForm" class="space-y-4">
                    <div>
                        <label class="block text-sm font-medium text-gray-600 mb-1">‡∏ä‡∏∑‡πà‡∏≠</label>
                        <input type="text" id="name" required class="w-full p-2.5 rounded-lg border border-gray-300 focus:ring-2 focus:ring-yellow-100 focus:border-yellow-400 outline-none transition" placeholder="‡∏Å‡∏£‡∏≠‡∏Å‡∏ä‡∏∑‡πà‡∏≠‡∏Ç‡∏≠‡∏á‡∏Ñ‡∏∏‡∏ì">
                    </div>
                    
                    <div>
                        <label class="block text-sm font-medium text-gray-600 mb-1">‡∏ö‡∏ó‡∏ö‡∏≤‡∏ó</label>
                        <input type="text" id="role" required class="w-full p-2.5 rounded-lg border border-gray-300 focus:ring-2 focus:ring-yellow-100 focus:border-yellow-400 outline-none transition" placeholder="‡πÄ‡∏ä‡πà‡∏ô ‡∏ú‡∏π‡πâ‡∏Å‡∏•‡πâ‡∏≤, ‡∏ä‡∏≤‡∏ß‡∏ö‡πâ‡∏≤‡∏ô">
                    </div>

                    <div>
                        <label class="block text-sm font-medium text-yellow-600 mb-1">üåü ‡πÅ‡∏ï‡πâ‡∏°‡∏ö‡∏∏‡∏ç (Merit)</label>
                        <input type="number" id="merit" class="w-full p-2.5 rounded-lg border border-gray-300 focus:border-yellow-400 outline-none bg-yellow-50" placeholder="0">
                    </div>

                    <div>
                        <label class="block text-sm font-medium text-red-600 mb-1">üî• ‡πÅ‡∏ï‡πâ‡∏°‡∏ö‡∏≤‡∏õ (Sin)</label>
                        <input type="number" id="sin" class="w-full p-2.5 rounded-lg border border-gray-300 focus:border-red-400 outline-none bg-red-50" placeholder="0">
                    </div>

                    <div>
                        <label class="block text-sm font-medium text-gray-600 mb-1">‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å</label>
                        <input type="date" id="date" required class="w-full p-2.5 rounded-lg border border-gray-300 focus:border-blue-400 outline-none">
                    </div>

                    <button type="submit" id="submitBtn" class="w-full bg-gradient-to-r from-yellow-500 to-orange-500 hover:from-yellow-600 hover:to-orange-600 text-white font-semibold py-3 rounded-xl shadow-lg shadow-yellow-500/30 transition active:scale-95">
                        ‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•
                    </button>
                </form>
            </div>
        </section>

        <section id="sec-history" class="hidden-section space-y-3">
            <h2 class="text-lg font-semibold text-gray-700 pl-1">‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥‡∏Å‡∏≤‡∏£‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Ç‡∏≠‡∏á‡∏â‡∏±‡∏ô</h2>
            <div id="history-list" class="space-y-3">
                </div>
        </section>

        <section id="sec-leaderboard" class="hidden-section">
            <h2 class="text-lg font-semibold text-gray-700 mb-3 pl-1">üèÜ ‡∏ï‡∏≤‡∏£‡∏≤‡∏á‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô‡∏Å‡∏£‡∏£‡∏° (‡∏£‡∏ß‡∏°‡∏¢‡∏≠‡∏î)</h2>
            <div class="bg-white rounded-2xl shadow-sm border border-gray-100 overflow-hidden">
                <table class="w-full text-left">
                    <thead class="bg-gray-50 text-gray-500 text-xs uppercase font-semibold">
                        <tr>
                            <th class="px-3 py-3 w-8 text-center">#</th>
                            <th class="px-2 py-3">‡∏ä‡∏∑‡πà‡∏≠</th>
                            <th class="px-2 py-3 text-center text-yellow-600">‡∏ö‡∏∏‡∏ç</th>
                            <th class="px-3 py-3 text-center text-red-600">‡∏ö‡∏≤‡∏õ</th>
                        </tr>
                    </thead>
                    <tbody id="leaderboard-list" class="divide-y divide-gray-100 text-sm">
                        </tbody>
                </table>
            </div>
        </section>

    </main>

    <button onclick="toggleModal()" class="fixed bottom-4 right-4 bg-white text-gray-400 p-3 rounded-full shadow-lg border border-gray-200 hover:bg-gray-50 z-50">
        <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z" />
        </svg>
    </button>
    <div id="infoModal" class="fixed inset-0 bg-black bg-opacity-50 z-50 hidden flex items-center justify-center p-4">
        <div class="bg-white rounded-2xl p-6 max-w-sm w-full shadow-2xl">
            <h3 class="text-lg font-bold text-gray-800 mb-2">‡∏Ç‡πâ‡∏≠‡∏ä‡∏µ‡πâ‡πÅ‡∏à‡∏á</h3>
            <ul class="text-sm text-gray-600 space-y-2 list-disc list-inside mb-6">
                <li>‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô "‡∏ö‡∏∏‡∏ç" ‡πÅ‡∏•‡∏∞ "‡∏ö‡∏≤‡∏õ" ‡∏à‡∏∞‡∏ñ‡∏π‡∏Å‡∏™‡∏∞‡∏™‡∏°‡∏£‡∏ß‡∏°‡∏¢‡∏≠‡∏î‡∏à‡∏≤‡∏Å‡∏ä‡∏∑‡πà‡∏≠‡πÄ‡∏î‡∏¥‡∏°</li>
                <li>‡πÇ‡∏õ‡∏£‡∏î‡∏Å‡∏£‡∏≠‡∏Å‡∏ä‡∏∑‡πà‡∏≠‡πÉ‡∏´‡πâ‡∏ï‡∏£‡∏á‡πÄ‡∏î‡∏¥‡∏°‡∏ó‡∏∏‡∏Å‡∏Ñ‡∏£‡∏±‡πâ‡∏á‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏™‡∏∞‡∏™‡∏°‡πÅ‡∏ï‡πâ‡∏°</li>
            </ul>
            <button onclick="toggleModal()" class="w-full bg-gray-100 text-gray-700 font-semibold py-2 rounded-lg hover:bg-gray-200">‡∏õ‡∏¥‡∏î‡∏´‡∏ô‡πâ‡∏≤‡∏ï‡πà‡∏≤‡∏á</button>
        </div>
    </div>

    <script>
        // *** ‡∏ß‡∏≤‡∏á URL Apps Script ‡∏ó‡∏µ‡πà‡πÑ‡∏î‡πâ‡∏à‡∏≤‡∏Å‡∏Å‡∏≤‡∏£ Deploy ‡πÉ‡∏´‡∏°‡πà‡∏ó‡∏µ‡πà‡∏ô‡∏µ‡πà ***
        const SCRIPT_URL = "https://script.google.com/macros/s/AKfycby_mW8OmNbuRgjettu_wrnnfXS3cP5IiJBuc9qYX2OCgH4RFyss4UwpInYJav8vP400Pg/exec"; 
        
        let currentUserId = "GUEST_USER";

        async function main() {
            // LIFF INIT CODE HERE (‡∏ñ‡πâ‡∏≤‡∏°‡∏µ)
            // ...
        }
        main();

        function switchTab(tabName) {
            ['form', 'history', 'leaderboard'].forEach(t => {
                document.getElementById(`sec-${t}`).classList.add('hidden-section');
                document.getElementById(`btn-${t}`).classList.remove('tab-active');
            });
            document.getElementById(`sec-${tabName}`).classList.remove('hidden-section');
            document.getElementById(`btn-${tabName}`).classList.add('tab-active');

            if (tabName === 'history') loadHistory();
            if (tabName === 'leaderboard') loadLeaderboard();
        }

        document.getElementById('scoreForm').addEventListener('submit', function(e) {
            e.preventDefault();
            const btn = document.getElementById('submitBtn');
            const originalBtnText = btn.innerText;
            btn.innerText = "‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏™‡πà‡∏á‡∏Å‡∏£‡∏£‡∏°...";
            btn.disabled = true;

            const formData = {
                userId: currentUserId,
                name: document.getElementById('name').value,
                role: document.getElementById('role').value,
                merit: document.getElementById('merit').value || 0, // ‡∏ñ‡πâ‡∏≤‡πÑ‡∏°‡πà‡∏Å‡∏£‡∏≠‡∏Å‡πÉ‡∏´‡πâ‡πÄ‡∏õ‡πá‡∏ô 0
                sin: document.getElementById('sin').value || 0,     // ‡∏ñ‡πâ‡∏≤‡πÑ‡∏°‡πà‡∏Å‡∏£‡∏≠‡∏Å‡πÉ‡∏´‡πâ‡πÄ‡∏õ‡πá‡∏ô 0
                date: document.getElementById('date').value
            };

            fetch(SCRIPT_URL, {
                method: 'POST',
                body: JSON.stringify(formData)
            })
            .then(() => {
                saveHistoryToLocal(formData);
                alert("‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Å‡∏£‡∏£‡∏°‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢! üôè");
                document.getElementById('scoreForm').reset();
                btn.innerText = originalBtnText;
                btn.disabled = false;
                if(!document.getElementById('sec-history').classList.contains('hidden-section')){
                    loadHistory();
                }
            })
            .catch(err => {
                console.error(err);
                alert("‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡∏™‡πà‡∏á ‡πÅ‡∏ï‡πà‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡πÉ‡∏ô‡πÄ‡∏Ñ‡∏£‡∏∑‡πà‡∏≠‡∏á‡πÑ‡∏ß‡πâ‡πÅ‡∏•‡πâ‡∏ß");
                btn.disabled = false;
            });
        });

        function saveHistoryToLocal(data) {
            let history = JSON.parse(localStorage.getItem('myKarmaHistory') || '[]');
            history.unshift(data); // ‡πÄ‡∏Å‡πá‡∏ö‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î‡∏•‡∏á LocalStorage
            localStorage.setItem('myKarmaHistory', JSON.stringify(history));
        }

        function loadHistory() {
            const list = document.getElementById('history-list');
            list.innerHTML = "";
            const data = JSON.parse(localStorage.getItem('myKarmaHistory') || '[]');

            if(data.length === 0) {
                list.innerHTML = '<div class="text-center text-gray-400 mt-10">‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥</div>';
                return;
            }

            data.forEach(item => {
                const div = document.createElement('div');
                div.className = "bg-white p-4 rounded-xl shadow-sm border border-gray-100 flex justify-between items-center";
                div.innerHTML = `
                    <div>
                        <div class="text-xs text-gray-400">${item.date}</div>
                        <div class="font-bold text-gray-700">${item.role}</div>
                    </div>
                    <div class="text-right">
                        ${item.merit > 0 ? `<div class="text-sm font-bold text-yellow-600">‡∏ö‡∏∏‡∏ç +${item.merit}</div>` : ''}
                        ${item.sin > 0 ? `<div class="text-sm font-bold text-red-500">‡∏ö‡∏≤‡∏õ +${item.sin}</div>` : ''}
                    </div>
                `;
                list.appendChild(div);
            });
        }

        function loadLeaderboard() {
            const list = document.getElementById('leaderboard-list');
            list.innerHTML = '<tr><td colspan="4" class="text-center py-4 text-gray-400">‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÇ‡∏´‡∏•‡∏î‡∏ö‡∏±‡∏ç‡∏ä‡∏µ‡∏Å‡∏£‡∏£‡∏°...</td></tr>';

            fetch(`${SCRIPT_URL}?action=leaderboard`)
            .then(res => res.json())
            .then(data => {
                list.innerHTML = "";
                data.forEach((item, index) => {
                    // ‡∏à‡∏±‡∏î‡∏≠‡∏±‡∏ô‡∏î‡∏±‡∏ö‡πÄ‡∏´‡∏£‡∏µ‡∏¢‡∏ç
                    let rankDisplay = index + 1;
                    if(index === 0) rankDisplay = "ü•á";
                    if(index === 1) rankDisplay = "ü•à";
                    if(index === 2) rankDisplay = "ü•â";

                    const row = document.createElement('tr');
                    row.innerHTML = `
                        <td class="px-3 py-3 text-center font-bold text-gray-600">${rankDisplay}</td>
                        <td class="px-2 py-3">
                            <div class="font-bold text-gray-700 text-sm">${item.name}</div>
                            <div class="text-xs text-gray-400 truncate w-24">${item.role}</div>
                        </td>
                        <td class="px-2 py-3 text-center font-bold text-yellow-600 bg-yellow-50 rounded-lg">${item.merit}</td>
                        <td class="px-3 py-3 text-center font-bold text-red-500">${item.sin}</td>
                    `;
                    list.appendChild(row);
                });
            });
        }

        function toggleModal() {
            const modal = document.getElementById('infoModal');
            modal.classList.toggle('hidden');
        }
    </script>
</body>
</html>